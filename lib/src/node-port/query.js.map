{"version":3,"sources":["query.ts"],"names":[],"mappings":"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","file":"query.js","sourceRoot":"","sourcesContent":["/**\r\n * Created by bohoffi on 30.05.2017.\r\n */\r\nimport {RequestMethod} from '@angular/http';\r\nimport {Observable} from 'rxjs/Observable';\r\nimport 'rxjs/add/observable/defer';\r\nimport 'rxjs/add/observable/empty';\r\nimport 'rxjs/add/observable/of';\r\nimport 'rxjs/add/operator/mergeMap';\r\nimport 'rxjs/add/operator/merge';\r\n\r\nimport {SelectParams} from '../interfaces';\r\nimport {RunAction} from './runaction';\r\nimport {Table} from './table';\r\nimport {normalizeQueryParams} from './utils';\r\n\r\nexport class Query {\r\n\r\n  private _params: SelectParams;\r\n  private _table: Table;\r\n\r\n  constructor(params: SelectParams, table: Table) {\r\n    this._params = params;\r\n    this._table = table;\r\n  }\r\n\r\n  firstPage(): Observable<any> {\r\n    return new RunAction({\r\n      base: this._table.base,\r\n      method: RequestMethod.Get,\r\n      path: this._table.urlEncodedNameOrId,\r\n      params: normalizeQueryParams(this._params, {\r\n        api_key: this._table.base.airtable.options.apiKey\r\n      })\r\n    })\r\n      .perform()\r\n      .map(result => result.records);\r\n  }\r\n\r\n  eachPage(): Observable<any> {\r\n    return this._eachPage();\r\n  }\r\n\r\n  all(): Observable<any> {\r\n    return this._all();\r\n  }\r\n\r\n  private _eachPage(offset?: string, previous?: Observable<any>): Observable<any> {\r\n    const additional: any = {\r\n      api_key: this._table.base.airtable.options.apiKey\r\n    };\r\n\r\n    if (!!offset) {\r\n      additional['offset'] = offset;\r\n    }\r\n\r\n    return Observable.defer(\r\n      () => new RunAction({\r\n        base: this._table.base,\r\n        method: RequestMethod.Get,\r\n        path: this._table.urlEncodedNameOrId,\r\n        params: normalizeQueryParams(this._params, additional)\r\n      })\r\n        .perform()\r\n        .flatMap((result: any) => {\r\n          const items$ = !!previous\r\n            ? previous.merge(Observable.of(result.records))\r\n            : Observable.of(result.records);\r\n          const next$ = !!result.offset\r\n            ? this._eachPage(result.offset, Observable.of(result.records))\r\n            : Observable.empty();\r\n\r\n          return items$.merge(next$);\r\n        })\r\n    );\r\n  }\r\n\r\n  private _all(offset?: string, previous?: any[]): Observable<any> {\r\n    const additional: any = {\r\n      api_key: this._table.base.airtable.options.apiKey\r\n    };\r\n\r\n    if (!!offset) {\r\n      additional['offset'] = offset;\r\n    }\r\n\r\n    return Observable.defer(\r\n      () => new RunAction({\r\n        base: this._table.base,\r\n        method: RequestMethod.Get,\r\n        path: this._table.urlEncodedNameOrId,\r\n        params: normalizeQueryParams(this._params, additional)\r\n      })\r\n        .perform()\r\n        .flatMap((result: any) => {\r\n          const items$ = !!previous\r\n            ? Observable.of(previous.concat(result.records))\r\n            : Observable.of(result.records);\r\n          const next$ = !!result.offset\r\n            ? this._all(result.offset, result.records)\r\n            : Observable.empty();\r\n\r\n          return items$.merge(next$);\r\n        })\r\n    );\r\n  }\r\n}\r\n"]}